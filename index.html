<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speculative Trade Advisor (Free, GDELT)</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#0e162a; --panel2:#0b1020;
      --border:#1d2a44; --border2:#233357;
      --text:#e8eefc; --muted:rgba(232,238,252,.72);
      --accent:#2a5cff; --bad:#ff8080; --ok:#93ffb4;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--text);}
    header{padding:18px 18px;border-bottom:1px solid var(--border);background:#0b1020;}
    header h1{margin:0 0 6px;font-size:18px;}
    header p{margin:0;color:var(--muted);font-size:13px;line-height:1.35;}
    main{padding:16px 18px;max-width:1200px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr;}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;}
    input,select,textarea,button{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid var(--border2);
      background:var(--panel2);color:var(--text);padding:10px 11px;font-size:14px;
    }
    textarea{min-height:66px;resize:vertical;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
    button{cursor:pointer;font-weight:700;}
    button.primary{background:var(--accent);border-color:var(--accent);}
    button.ghost{background:transparent;}
    button:disabled{opacity:.65;cursor:not-allowed;}
    .status{margin-top:10px;font-size:13px;color:var(--muted);}
    .status.error{color:var(--bad);}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .pill{border:1px solid var(--border2);background:var(--panel2);padding:5px 9px;border-radius:999px;font-size:12px;color:var(--muted);}
    .rightHead{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .rightHead h2{margin:0;font-size:16px;}
    .rightHead .small{font-size:12px;color:var(--muted);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border2);background:var(--panel2);font-size:12px;color:var(--muted);cursor:pointer;user-select:none;}
    .tab.active{border-color:var(--accent);color:var(--text);}
    .results{display:grid;gap:10px;}
    .item{border-radius:14px;border:1px solid var(--border);background:var(--panel2);padding:12px;}
    .item .title{margin:0 0 6px;font-weight:800;line-height:1.25;}
    .item a{color:#9dc0ff;text-decoration:none;}
    .item a:hover{text-decoration:underline;}
    .sub{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted);}
    .scoreline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:var(--muted);}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border2);background:#0b1020;padding:4px 8px;border-radius:999px;}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block;}
    .dot.ok{background:var(--ok);}
    .dot.bad{background:var(--bad);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .smallnote{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px;}
    .hr{height:1px;background:var(--border);margin:10px 0;}
    .rangeWrap{display:grid;grid-template-columns:1fr 90px;gap:10px;align-items:center;}
  </style>
</head>

<body>
<header>
  <h1>Speculative Trade Advisor (Free, GDELT)</h1>
  <p>
    Free-only, deterministic scanner: fetches headlines (GDELT DOC 2.0), filters for tradable catalysts, scores tradeability (1–10),
    and ranks 3 candidates for a ~15–20 trading day event window. Research tool only.
  </p>
</header>

<main class="grid">
  <!-- LEFT: Controls -->
  <section class="card">
    <div class="row">
      <div>
        <label>Lookback (TIMESPAN)</label>
        <select id="timespan">
          <option value="1h">Last 1 hour</option>
          <option value="6h">Last 6 hours</option>
          <option value="12h" selected>Last 12 hours</option>
          <option value="1day">Last 1 day</option>
          <option value="3day">Last 3 days</option>
          <option value="1week">Last 1 week</option>
        </select>
      </div>
      <div>
        <label>Sort</label>
        <select id="sort">
          <option value="datedesc" selected>Date (newest first)</option>
          <option value="">Relevance</option>
          <option value="toneasc">Tone (most negative)</option>
          <option value="tonedesc">Tone (most positive)</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Headlines / topic</label>
        <input id="perTopic" type="number" min="1" max="25" value="5" />
      </div>
      <div>
        <label>Concurrency</label>
        <input id="concurrency" type="number" min="1" max="10" value="4" />
      </div>
      <div>
        <label>Time zone display</label>
        <select id="tz">
          <option value="Asia/Jerusalem" selected>Asia/Jerusalem</option>
          <option value="UTC">UTC</option>
          <option value="America/New_York">America/New_York</option>
          <option value="Europe/London">Europe/London</option>
        </select>
      </div>
    </div>

    <label>Strictness / Sensitivity</label>
    <div class="rangeWrap">
      <input id="strictness" type="range" min="0" max="100" value="70" />
      <input id="strictnessNum" type="number" min="0" max="100" value="70" />
    </div>
    <div class="smallnote" id="strictnessHint">
      70 = strict (more NO TRADE). Lower = more trades (lower confidence).
    </div>

    <label>Optional filters (applied to all topics)</label>
    <div class="row">
      <input id="lang" placeholder="sourcelang (e.g. english)" />
      <input id="country" placeholder="sourcecountry (e.g. unitedstates)" />
    </div>

    <label>Optional: custom topic query override (advanced)</label>
    <textarea id="customQuery" placeholder='Leave blank. Example: ("sanctions" OR "export controls") sourcelang:english'></textarea>

    <div class="actions">
      <button id="runBtn" class="primary">Run Scan</button>
      <button id="saveBtn" class="ghost" disabled>Save to History</button>
    </div>

    <div class="actions" style="grid-template-columns:1fr 1fr;">
      <button id="exportBtn" class="ghost" disabled>Export JSON</button>
      <button id="clearHistoryBtn" class="ghost">Clear History</button>
    </div>

    <div id="status" class="status"></div>
    <div id="pills" class="pillbar"></div>

    <div class="smallnote">
      This version mimics “GPT rules” without paid APIs by using catalyst filtering, signed winner/loser weights,
      liquidity gating, ETF preference, and a NO TRADE decision. Use Strictness to relax gates.
    </div>

    <div class="hr"></div>

    <label>History (localStorage)</label>
    <select id="history"></select>
    <div class="smallnote">Select a past scan to re-load results without re-fetching news.</div>
  </section>

  <!-- RIGHT: Results -->
  <section class="card">
    <div class="rightHead">
      <h2>Results</h2>
      <div id="meta" class="small"></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="picks">Top 3 Picks</div>
      <div class="tab" data-tab="headlines">Headlines by Topic</div>
      <div class="tab" data-tab="tickers">Ticker Table</div>
      <div class="tab" data-tab="method">Method</div>
    </div>

    <div id="viewPicks" class="results"></div>
    <div id="viewHeadlines" class="results" style="display:none;"></div>
    <div id="viewTickers" class="results" style="display:none;"></div>
    <div id="viewMethod" class="results" style="display:none;"></div>
  </section>
</main>

<script>
(() => {
  // ---------- Constants ----------
  const GDELT_ENDPOINT = "https://api.gdeltproject.org/api/v2/doc/doc";

  const TICKER_GROUPS = {
    defense: ["PPA","ITA","LMT","NOC","GD","RTX","BA","HII","LHX","TDG","AVAV","KTOS"],
    cyber: ["CIBR","HACK","PANW","CRWD","FTNT","ZS","OKTA","NET"],
    semis: ["SMH","SOXX","NVDA","AVGO","TSM","MU","ASML","AMAT","LRCX","KLAC","AMD","ARM","MRVL"],
    energy: ["XLE","XOP","LNG","VLO","CVX","XOM","SLB","HAL","OIH"],
    shipping: ["INSW","STNG","TK","ZIM","DAC"],
    uranium: ["URNM","URA","CCJ","UEC","LEU"],
    water_agri: ["PHO","MOO","DBA","NTR","MOS","CF","DE"],
    insurers: ["KIE","CB","TRV","ALL","AIG"],
    gold: ["GLD","IAU","GDX"]
  };

  const ETF_SET = new Set([
    "PPA","ITA","CIBR","HACK","SMH","SOXX",
    "XLE","XOP","OIH","KIE","URNM","URA",
    "PHO","MOO","DBA","GLD","IAU","GDX"
  ]);

  const TOPICS = [
    { key:"geopolitics", label:"geopolitics", terms:['geopolitics','"regional tensions"','"border clash"','"military buildup"','"diplomatic crisis"'] },
    { key:"sanctions", label:"sanctions", terms:['sanctions','"export controls"','"blacklist"','"secondary sanctions"','"asset freeze"'] },
    { key:"ceasefire", label:"ceasefire", terms:['ceasefire','"truce"','"peace talks"','"temporary halt"'] },
    { key:"war", label:"war", terms:['war','"airstrike"','"missile attack"','"ground offensive"','"troop deployment"'] },
    { key:"regulation", label:"regulation", terms:['regulation','"regulatory crackdown"','"antitrust"','"compliance rule"','"SEC"','"FTC"'] },
    { key:"tariff", label:"tariff", terms:['tariff','"trade war"','"import duty"','"export ban"'] },
    { key:"cyber", label:"cyber", terms:['cyber','"ransomware"','"data breach"','"DDoS"','"zero-day"','"hackers"'] },
    { key:"earthquake", label:"earthquake", terms:['earthquake','"seismic"','"aftershock"','"magnitude"'] },
    { key:"flood", label:"flood", terms:['flood','"flash flood"','"storm surge"','"river overflow"'] },
    { key:"wildfire", label:"wildfire", terms:['wildfire','"forest fire"','"evacuation order"','"burning"'] },
    { key:"inflation", label:"inflation", terms:['inflation','"CPI"','"PCE"','"price pressures"','"core inflation"'] },
    { key:"rates", label:"rates", terms:['"interest rate"','"rate hike"','"rate cut"','"policy rate"','"Federal Reserve"','ECB','BoE'] },
    { key:"recession", label:"recession", terms:['recession','"GDP contraction"','"yield curve"','"job losses"','"hard landing"'] },
    { key:"OPEC", label:"OPEC", terms:['OPEC','"OPEC+"','"oil output"','"production cut"','"quota"'] },
    { key:"oil", label:"oil", terms:['"crude oil"','Brent','WTI','"oil prices"','"oil supply"'] }
  ];

  const TOPIC_SECTOR_WEIGHTS = {
    geopolitics: { defense:+0.80, energy:+0.55, shipping:+0.20, gold:+0.40, insurers:-0.10, semis:-0.05, cyber:+0.10 },
    sanctions:   { energy:+0.30, shipping:+0.20, defense:+0.20, semis:-0.25, gold:+0.25 },
    ceasefire:   { defense:-0.45, energy:-0.20, shipping:+0.35, gold:-0.25, insurers:+0.10 },
    war:         { defense:+0.95, energy:+0.55, gold:+0.65, shipping:+0.10, insurers:-0.20, cyber:+0.10 },

    regulation:  { insurers:+0.20, semis:-0.10, energy:-0.05, cyber:+0.05 },
    tariff:      { semis:-0.25, shipping:-0.10, energy:+0.05, gold:+0.05 },

    cyber:       { cyber:+0.95, defense:+0.05 },

    earthquake:  { insurers:-0.35, water_agri:+0.20, energy:-0.05 },
    flood:       { insurers:-0.30, water_agri:+0.25, energy:-0.05 },
    wildfire:    { insurers:-0.25, water_agri:+0.25, energy:+0.05 },

    inflation:   { gold:+0.35, energy:+0.20, insurers:+0.05, semis:-0.05 },

    rates_cut:   { semis:+0.20, energy:+0.05, shipping:+0.05, gold:-0.15, insurers:-0.05 },
    rates_hike:  { insurers:+0.20, gold:-0.10, semis:-0.15, energy:-0.05 },

    recession:   { gold:+0.45, insurers:-0.15, semis:-0.20, energy:-0.15 },

    OPEC:        { energy:+0.85, shipping:+0.15, gold:+0.05 },
    oil:         { energy:+0.75, shipping:+0.10, gold:+0.05 }
  };

  const LIQ = Object.fromEntries([
    ["PPA",0.75],["ITA",0.8],["CIBR",0.8],["HACK",0.7],["SMH",0.85],["SOXX",0.85],
    ["XLE",0.9],["XOP",0.75],["OIH",0.6],["KIE",0.65],["URNM",0.55],["URA",0.65],
    ["PHO",0.55],["MOO",0.55],["DBA",0.6],["GLD",0.95],["IAU",0.85],["GDX",0.75],
    ["NVDA",0.95],["AVGO",0.9],["TSM",0.9],["AMD",0.9],["XOM",0.9],["CVX",0.85],
    ["BA",0.85],["RTX",0.8],["LMT",0.75],["PANW",0.8],["CRWD",0.8],["NET",0.75],
    ["AVAV",0.55],["KTOS",0.5],["HII",0.45],["INSW",0.45],["STNG",0.5],["TK",0.4],
    ["ZIM",0.6],["DAC",0.45],["UEC",0.45],["LEU",0.45]
  ]);

  const VOL = Object.fromEntries([
    ["NVDA",0.9],["AMD",0.85],["ARM",0.85],["MRVL",0.8],["MU",0.85],
    ["XOP",0.8],["OIH",0.85],["HAL",0.75],["SLB",0.7],
    ["ZIM",0.9],["STNG",0.75],["INSW",0.6],
    ["CRWD",0.8],["PANW",0.65],["NET",0.75],["FTNT",0.65],
    ["GLD",0.35],["GDX",0.6],["IAU",0.3],
    ["LMT",0.35],["NOC",0.35],["RTX",0.4],["BA",0.6],["KTOS",0.7],["AVAV",0.65],
    ["KIE",0.35],["AIG",0.45],["ALL",0.35]
  ]);

  const DEFAULT_LIQ = 0.55;
  const DEFAULT_VOL = 0.55;

  // ---------- UI ----------
  const el = {
    timespan: document.getElementById("timespan"),
    sort: document.getElementById("sort"),
    perTopic: document.getElementById("perTopic"),
    concurrency: document.getElementById("concurrency"),
    tz: document.getElementById("tz"),
    strictness: document.getElementById("strictness"),
    strictnessNum: document.getElementById("strictnessNum"),
    strictnessHint: document.getElementById("strictnessHint"),
    lang: document.getElementById("lang"),
    country: document.getElementById("country"),
    customQuery: document.getElementById("customQuery"),
    runBtn: document.getElementById("runBtn"),
    saveBtn: document.getElementById("saveBtn"),
    exportBtn: document.getElementById("exportBtn"),
    clearHistoryBtn: document.getElementById("clearHistoryBtn"),
    status: document.getElementById("status"),
    pills: document.getElementById("pills"),
    meta: document.getElementById("meta"),
    history: document.getElementById("history"),
    viewPicks: document.getElementById("viewPicks"),
    viewHeadlines: document.getElementById("viewHeadlines"),
    viewTickers: document.getElementById("viewTickers"),
    viewMethod: document.getElementById("viewMethod")
  };

  let lastScan = null;

  // ---------- Runtime tuning (Strictness) ----------
  const RUNTIME = {
    strictness: 0.70,   // 0..1
    liqFloor: 0.55,     // dynamic
    etfBonus: 1.12,     // dynamic
    minCatalysts: 2,    // dynamic
    minAvgTrade01: 0.58 // dynamic
  };

  function applyStrictnessFromUI(){
    const v = Math.max(0, Math.min(100, Number(el.strictness.value || 70)));
    el.strictness.value = String(v);
    el.strictnessNum.value = String(v);

    const s = v / 100;
    RUNTIME.strictness = s;

    // Relax as strictness falls
    RUNTIME.liqFloor = 0.45 + s * (0.55 - 0.45);           // 0.45..0.55
    RUNTIME.etfBonus = 1.06 + s * (1.12 - 1.06);           // 1.06..1.12
    RUNTIME.minCatalysts = Math.round(1 + s * 1);          // 1..2
    RUNTIME.minAvgTrade01 = 0.40 + s * (0.58 - 0.40);      // 0.40..0.58

    const label = v >= 70 ? "strict" : v >= 45 ? "balanced" : "lenient";
    el.strictnessHint.textContent =
      `${v} = ${label} | minStrong=${RUNTIME.minCatalysts}, minAvg=${RUNTIME.minAvgTrade01.toFixed(2)}, liqFloor=${RUNTIME.liqFloor.toFixed(2)}, ETFbonus=${RUNTIME.etfBonus.toFixed(2)}`;
  }

  // ---------- Helpers ----------
  const clamp01 = (x) => Math.max(0, Math.min(1, x));
  const round2 = (x) => Math.round(x * 100) / 100;

  function setStatus(msg, isError=false){
    el.status.textContent = msg || "";
    el.status.className = "status" + (isError ? " error" : "");
  }
  function setPills(pairs){
    el.pills.innerHTML = "";
    for(const [k,v] of pairs){
      const d = document.createElement("div");
      d.className = "pill";
      d.textContent = `${k}: ${v}`;
      el.pills.appendChild(d);
    }
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtDate(dt, tz){
    try{
      return new Intl.DateTimeFormat(undefined, {
        timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(dt);
    }catch{
      return dt.toISOString();
    }
  }

  function buildQueryFromTerms(terms, lang, country){
    const core = "(" + terms.join(" OR ") + ")";
    let q = core;
    if(lang) q += ` sourcelang:${lang}`;
    if(country) q += ` sourcecountry:${country}`;
    return q.trim();
  }

  function buildGdeltUrl({ query, timespan, sort, maxrecords }){
    const url = new URL(GDELT_ENDPOINT);
    url.searchParams.set("query", query);
    url.searchParams.set("mode", "artlist");
    url.searchParams.set("format", "json");
    url.searchParams.set("timespan", timespan);
    url.searchParams.set("maxrecords", String(maxrecords));
    if(sort) url.searchParams.set("sort", sort);
    return url.toString();
  }

  async function mapLimit(items, limit, worker){
    const results = new Array(items.length);
    let i = 0;
    const runners = Array.from({length: Math.max(1, limit)}, async () => {
      while(i < items.length){
        const idx = i++;
        results[idx] = await worker(items[idx], idx);
      }
    });
    await Promise.all(runners);
    return results;
  }

  // ---------- Catalyst logic ----------
  function isCatalystHeadline(title){
    const t = (title || "").toLowerCase();

    // Always reject obvious non-catalyst formats
    const hardReject = [
      "what you need to know","explainer","analysis","opinion","live updates","recap",
      "how to","watch live","timeline","faq"
    ];
    if(hardReject.some(w => t.includes(w))) return false;

    const hasNumber = /(\d+(\.\d+)?)|(%|\$|bps|basis points|million|billion|mbpd)/i.test(title || "");

    const strongTerms = [
      "announces","imposes","approves","bans","ban","halts","suspends","launches",
      "cuts","raises","hikes","slashes","sanctions","tariff","export controls",
      "airstrike","missile","attack","offensive","troop","mobilization",
      "breach","ransomware","zero-day","exploit",
      "evacuation","earthquake","magnitude","flood","wildfire",
      "opec","opec+","production cut","quota",
      "cpi","pce","federal reserve","ecb","boe","rate cut","rate hike"
    ];
    const hasStrong = strongTerms.some(w => t.includes(w));

    if(hasNumber || hasStrong) return true;

    // Lenient mode: allow “weak but relevant” topic mentions
    if(RUNTIME.strictness <= 0.45){
      const topicWords = ["sanction","ceasefire","tariff","cyber","earthquake","flood","wildfire","inflation","recession","opec","oil","war","strike"];
      if(topicWords.some(w => t.includes(w))) return true;
    }

    return false;
  }

  function effectiveTopicKey(topicKey, title){
    const t = (title || "").toLowerCase();

    if(topicKey === "ceasefire"){
      const breakdown = ["violat","collapse","breaks down","ends","resumes","renewed","new attack","fails"];
      if(breakdown.some(w => t.includes(w))) return "war";
      return "ceasefire";
    }

    if(topicKey === "rates"){
      if(t.includes("rate cut") || t.includes("cuts rates") || t.includes("cut interest")) return "rates_cut";
      if(t.includes("rate hike") || t.includes("hikes rates") || t.includes("raise rates")) return "rates_hike";
      return "rates_hike";
    }

    return topicKey;
  }

  function catalystClarity(title){
    const t = (title || "").toLowerCase();
    let score = 0.20;

    const hasNumber = /(\d+(\.\d+)?)|(%|\$|bps|basis points|million|billion|mbpd)/i.test(title || "");
    if(hasNumber) score += 0.18;

    const actionVerbs = [
      "announces","imposes","approves","ban","bans","halts","suspends","launches","strikes","attacks",
      "cuts","raises","hikes","slashes","warns","sanctions","tariff","export controls","ceasefire",
      "breach","ransomware","hack","exploit","zero-day","evacuation","earthquake","flood","wildfire"
    ];
    for(const w of actionVerbs){
      if(t.includes(w)) score += 0.03;
    }

    const specificityHints = ["opec","fed","ecb","boe","cpi","pce","brent","wti","pipeline","shipping lane","red sea","strait"];
    for(const w of specificityHints){
      if(t.includes(w)) score += 0.05;
    }

    const vague = ["what you need to know","explainer","analysis","opinion","why it matters","live updates"];
    for(const w of vague){
      if(t.includes(w)) score -= 0.06;
    }

    return clamp01(score);
  }

  function timingScore(seenDateUtc, nowUtc){
    if(!seenDateUtc || !(seenDateUtc instanceof Date) || isNaN(seenDateUtc)) return 0.55;
    const hours = Math.max(0, (nowUtc - seenDateUtc) / 36e5);
    const halfLifeHrs = 42;
    const score = Math.pow(0.5, hours / halfLifeHrs);
    return clamp01(0.15 + 0.85 * score);
  }

  function shockScore(title, topicKey){
    const t = (title || "").toLowerCase();
    let s = 0.35;

    const bump = (words, inc) => { if(words.some(w => t.includes(w))) s += inc; };

    if(["war","geopolitics","ceasefire"].includes(topicKey)){
      bump(["missile","airstrike","drone","ballistic","offensive","troops","mobilization"], 0.25);
      bump(["red sea","strait","shipping lane"], 0.10);
    } else if(["sanctions","tariff"].includes(topicKey)){
      bump(["export controls","blacklist","secondary sanctions","asset freeze","import duty","export ban"], 0.25);
    } else if(topicKey === "cyber"){
      bump(["ransomware","data breach","zero-day","critical vulnerability","exploit"], 0.30);
    } else if(["earthquake","flood","wildfire"].includes(topicKey)){
      bump(["magnitude","deadly","evacuat","infrastructure","power outage","refinery"], 0.25);
    } else if(["inflation","recession","rates_cut","rates_hike","rates"].includes(topicKey)){
      bump(["surprise","unexpected","beats","misses","guidance","bps","basis points"], 0.20);
      bump(["cpi","pce","fed","ecb","boe"], 0.15);
    } else if(["OPEC","oil"].includes(topicKey)){
      bump(["production cut","quota","output","supply shock","pipeline","brent","wti"], 0.25);
    }

    return clamp01(s);
  }

  function headlineTradeability({ topicKey, title, seenDate }, nowUtc){
    const clarity = catalystClarity(title);
    const timing  = timingScore(seenDate, nowUtc);

    if(!isCatalystHeadline(title)){
      // Strict mode: drop it
      if(RUNTIME.strictness >= 0.70){
        return { trade01: 0.0, score10: 1, clarity, timing, shock: 0, filteredOut: true, soft:false };
      }
      // Lenient mode: keep it, but low-confidence
      const shock = shockScore(title, topicKey);
      const raw = clamp01(0.20 * clarity + 0.35 * timing + 0.45 * shock) * 0.55;
      const score10 = Math.max(1, Math.min(10, Math.round(raw * 10)));
      return { trade01: raw, score10, clarity, timing, shock, filteredOut: false, soft:true };
    }

    const shock = shockScore(title, topicKey);
    const raw = clamp01(0.45 * clarity + 0.25 * timing + 0.30 * shock);
    const score10 = Math.max(1, Math.min(10, Math.round(raw * 10)));
    return { trade01: raw, score10, clarity, timing, shock, filteredOut: false, soft:false };
  }

  function tickerLiquidity(t){ return LIQ[t] ?? DEFAULT_LIQ; }
  function tickerVol(t){ return VOL[t] ?? DEFAULT_VOL; }

  function aggregateTickerScores(allHeadlines){
    const tickerInfo = {};
    const tickerToGroup = {};
    for(const [g, arr] of Object.entries(TICKER_GROUPS)){
      for(const t of arr) tickerToGroup[t] = g;
    }

    function ensure(t){
      if(!tickerInfo[t]){
        tickerInfo[t] = {
          ticker:t,
          group:tickerToGroup[t] || "unknown",
          liq:tickerLiquidity(t),
          vol:tickerVol(t),
          isEtf: ETF_SET.has(t),
          score:0,
          drivers:[]
        };
      }
      return tickerInfo[t];
    }

    for(const h of allHeadlines){
      const sectorWeights = TOPIC_SECTOR_WEIGHTS[h.topicKey] || {};
      const base = h.trade01 || 0;

      for(const [sector, w] of Object.entries(sectorWeights)){
        const tickers = TICKER_GROUPS[sector] || [];
        for(const t of tickers){
          const info = ensure(t);

          // Eligibility: keep ETFs; for stocks enforce liquidity floor
          if(!info.isEtf && info.liq < RUNTIME.liqFloor) continue;

          const lv = 0.65 * info.liq + 0.35 * info.vol;
          let add = base * w * lv;

          if(info.isEtf) add *= RUNTIME.etfBonus;

          info.score += add;

          if(add > 0.030){
            info.drivers.push({
              add,
              topicKey: h.topicKey,
              title: h.title,
              url: h.url,
              seenDate: h.seenDate,
              soft: !!h.soft
            });
          }
        }
      }
    }

    const arr = Object.values(tickerInfo);
    const maxPos = Math.max(0.0001, ...arr.map(x => x.score));

    for(const x of arr){
      x.scoreN = x.score / maxPos;
      x.score100 = Math.round(x.scoreN * 100);
      x.drivers.sort((a,b)=>b.add-a.add);
      x.drivers = x.drivers.slice(0,4);
    }

    arr.sort((a,b)=>b.score-a.score);
    return arr;
  }

  // ---------- Fetch ----------
  function parseGdeltSeenDate(s){
    if(!s) return null;
    const iso = String(s).replace(" ", "T") + "Z";
    const d = new Date(iso);
    return isNaN(d) ? null : d;
  }

  async function fetchTopic(topic, opts){
    const query = opts.customQuery?.trim()
      ? opts.customQuery.trim()
      : buildQueryFromTerms(topic.terms, opts.lang, opts.country);

    const url = buildGdeltUrl({
      query,
      timespan: opts.timespan,
      sort: opts.sort,
      maxrecords: opts.perTopic
    });

    const resp = await fetch(url);
    const text = await resp.text();

    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error(`Non-JSON from GDELT (HTTP ${resp.status}): ${text.slice(0,160)}`); }

    const articles = Array.isArray(data) ? data : (data.articles || data.data || []);
    return { topicKey: topic.key, topicLabel: topic.label, query, url, articles };
  }

  // ---------- Render ----------
  function setActiveTab(tab){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.dataset.tab === tab);
    });
    el.viewPicks.style.display = tab==="picks" ? "" : "none";
    el.viewHeadlines.style.display = tab==="headlines" ? "" : "none";
    el.viewTickers.style.display = tab==="tickers" ? "" : "none";
    el.viewMethod.style.display = tab==="method" ? "" : "none";
  }

  function renderMethod(){
    el.viewMethod.innerHTML = `
      <div class="item">
        <div class="title">Method (Free-only GPT-like rules + Strictness)</div>
        <div class="smallnote">
          Headlines are filtered for likely price-moving catalysts. Strictness controls how hard the filter and “NO TRADE” gates are.
          Tradeability (1–10) comes from:
        </div>
        <div class="scoreline">
          <span class="badge"><span class="dot ok"></span><b>Clarity</b> (numbers, actions, institutions)</span>
          <span class="badge"><span class="dot ok"></span><b>Timing</b> (recency decay)</span>
          <span class="badge"><span class="dot ok"></span><b>Shock</b> (keyword intensity)</span>
        </div>
        <div class="smallnote">
          Ticker ranking uses signed winner/loser sector weights, liquidity gating, and an ETF preference bonus.
          At low strictness, the system may keep weaker headlines as “soft” catalysts to propose ideas.
        </div>
      </div>
    `;
  }

  function renderPicks(scan){
    if(scan.noTrade){
      el.viewPicks.innerHTML = `
        <div class="item">
          <div class="title">NO TRADE</div>
          <div class="sub">
            <span class="badge"><span class="dot bad"></span><b>Strong catalysts:</b> ${scan.strongCatalysts}</span>
            <span class="badge"><b>Avg tradeability:</b> ${round2(scan.avgTrade01)}</span>
            <span class="badge"><b>Kept catalysts:</b> ${scan.countKept}</span>
            <span class="badge"><b>Strictness:</b> ${scan.strictnessPct}%</span>
          </div>
          <div class="smallnote" style="margin-top:8px;">
            Reduce Strictness to force more trade ideas (with lower confidence), or increase lookback.
          </div>
        </div>
      `;
      return;
    }

    const picks = scan.topPicks || [];
    if(!picks.length){
      el.viewPicks.innerHTML = `<div class="item">No picks.</div>`;
      return;
    }

    const tz = scan.opts.tz;

    el.viewPicks.innerHTML = picks.map((p, idx) => {
      const drivers = (p.drivers || []).map(d => {
        const when = d.seenDate ? fmtDate(new Date(d.seenDate), tz) : "";
        const soft = d.soft ? `<span class="badge"><span class="dot bad"></span>soft</span>` : "";
        return `
          <div class="sub" style="margin-top:6px;">
            <span class="badge"><span class="dot ok"></span>+${round2(d.add)} driver</span>
            ${soft}
            <span>${escapeHtml(d.topicKey)}</span>
            <a href="${escapeHtml(d.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(d.title)}</a>
            <span>${escapeHtml(when)}</span>
          </div>
        `;
      }).join("");

      return `
        <div class="item">
          <div class="title">${idx+1}) ${escapeHtml(p.ticker)} <span class="badge">${escapeHtml(p.group)}</span></div>
          <div class="sub">
            <span class="badge"><span class="dot ok"></span><b>Setup score:</b> ${p.score100}/100</span>
            <span class="badge"><b>ETF:</b> ${p.isEtf ? "yes" : "no"}</span>
            <span class="badge"><b>Liq:</b> ${round2(p.liq)}</span>
            <span class="badge"><b>Vol:</b> ${round2(p.vol)}</span>
          </div>
          <div class="smallnote" style="margin-top:8px;">
            Reasoning: strongest net “winner” exposure to kept catalysts, with liq/vol profile suited for a 15–20 day reaction window.
          </div>
          ${drivers ? `<div style="margin-top:8px;"><div class="sub"><b>Top drivers:</b></div>${drivers}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  function renderHeadlines(scan){
    const tz = scan.opts.tz;

    const blocks = scan.byTopic.map(t => {
      const items = (t.items || []).map(h => {
        const when = h.seenDate ? fmtDate(new Date(h.seenDate), tz) : "";
        const dotClass = h.score10 >= 7 ? "ok" : (h.score10 <= 3 ? "bad" : "");
        const soft = h.soft ? `<span class="badge"><span class="dot bad"></span>soft</span>` : "";
        return `
          <div class="item">
            <div class="title">
              <a href="${escapeHtml(h.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(h.title)}</a>
            </div>
            <div class="sub">
              <span>${escapeHtml(h.domain || "")}</span>
              <span>${escapeHtml(when)}</span>
              <span class="badge"><span class="dot ${dotClass}"></span><b>Tradeability:</b> ${h.score10}/10</span>
              ${soft}
              <span class="badge"><b>Clarity:</b> ${round2(h.clarity)}</span>
              <span class="badge"><b>Timing:</b> ${round2(h.timing)}</span>
              <span class="badge"><b>Shock:</b> ${round2(h.shock)}</span>
            </div>
            <div class="smallnote mono" style="margin-top:8px; word-break:break-word;">${escapeHtml(h.url)}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="item">
          <div class="title">${escapeHtml(t.topicLabel)}
            <span class="badge">raw ${t.rawCount}</span>
            <span class="badge">kept ${t.items.length}</span>
          </div>
          <div class="smallnote">Query: <span class="mono">${escapeHtml(t.query)}</span></div>
          <div class="smallnote">Source: <a href="${escapeHtml(t.url)}" target="_blank" rel="noopener noreferrer">open in GDELT</a></div>
          ${t.error ? `<div class="smallnote" style="color:var(--bad);">Error: ${escapeHtml(t.error)}</div>` : ""}
          <div style="margin-top:10px;" class="results">${items || `<div class="item">No kept catalysts for this topic.</div>`}</div>
        </div>
      `;
    }).join("");

    el.viewHeadlines.innerHTML = blocks || `<div class="item">No headlines.</div>`;
  }

  function renderTickers(scan){
    const rows = (scan.tickerTable || []).slice(0, 40).map(x => {
      return `
        <div class="item">
          <div class="title">${escapeHtml(x.ticker)} <span class="badge">${escapeHtml(x.group)}</span></div>
          <div class="sub">
            <span class="badge"><b>Score:</b> ${x.score100}/100</span>
            <span class="badge"><b>ETF:</b> ${x.isEtf ? "yes" : "no"}</span>
            <span class="badge"><b>Liq:</b> ${round2(x.liq)}</span>
            <span class="badge"><b>Vol:</b> ${round2(x.vol)}</span>
          </div>
          ${x.drivers?.length ? `
            <div class="smallnote" style="margin-top:8px;">
              Drivers: ${x.drivers.map(d => `${escapeHtml(d.topicKey)} (+${round2(d.add)})${d.soft ? " [soft]" : ""}`).join(", ")}
            </div>
          ` : `<div class="smallnote" style="margin-top:8px;">No strong positive drivers detected.</div>`}
        </div>
      `;
    }).join("");
    el.viewTickers.innerHTML = rows || `<div class="item">No ticker table.</div>`;
  }

  function renderAll(scan){
    el.meta.textContent =
      `Scan @ ${fmtDate(new Date(scan.createdAt), scan.opts.tz)} | raw: ${scan.countRaw} | kept: ${scan.countKept} | strong: ${scan.strongCatalysts} | avg: ${round2(scan.avgTrade01)} | strict: ${scan.strictnessPct}%`;
    renderPicks(scan);
    renderHeadlines(scan);
    renderTickers(scan);
    renderMethod();
  }

  // ---------- History ----------
  const STORAGE_KEY = "trade_scanner_history_v3";

  function loadHistory(){
    const raw = localStorage.getItem(STORAGE_KEY);
    let arr = [];
    try { arr = raw ? JSON.parse(raw) : []; } catch {}
    return Array.isArray(arr) ? arr : [];
  }

  function saveHistory(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0, 30)));
  }

  function refreshHistoryDropdown(){
    const arr = loadHistory();
    el.history.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "— Select saved scan —";
    el.history.appendChild(opt0);

    for(let i=0;i<arr.length;i++){
      const s = arr[i];
      const o = document.createElement("option");
      o.value = String(i);
      const dt = new Date(s.createdAt);
      const top = (s.topPicks || []).map(x=>x.ticker).join(", ");
      o.textContent = `${i+1}) ${dt.toLocaleString()} | Top: ${top || (s.noTrade ? "NO TRADE" : "—")}`;
      el.history.appendChild(o);
    }
  }

  // ---------- Main run ----------
  async function runScan(){
    setStatus("");
    el.runBtn.disabled = true;
    el.saveBtn.disabled = true;
    el.exportBtn.disabled = true;

    applyStrictnessFromUI();

    const nowUtc = new Date();
    const opts = {
      timespan: el.timespan.value,
      sort: el.sort.value,
      perTopic: Math.max(1, Math.min(25, Number(el.perTopic.value || 5))),
      concurrency: Math.max(1, Math.min(10, Number(el.concurrency.value || 4))),
      tz: el.tz.value || "Asia/Jerusalem",
      lang: el.lang.value.trim(),
      country: el.country.value.trim(),
      customQuery: el.customQuery.value
    };

    setPills([
      ["timespan", opts.timespan],
      ["sort", opts.sort || "relevance"],
      ["perTopic", opts.perTopic],
      ["concurrency", opts.concurrency],
      ["strictness", `${Math.round(RUNTIME.strictness*100)}%`],
      ["minStrong", RUNTIME.minCatalysts],
      ["minAvg", RUNTIME.minAvgTrade01.toFixed(2)],
      ["liqFloor", RUNTIME.liqFloor.toFixed(2)],
      ["ETFbonus", RUNTIME.etfBonus.toFixed(2)],
      ["sourcelang", opts.lang || "—"],
      ["sourcecountry", opts.country || "—"]
    ]);

    setStatus("Fetching headlines from GDELT…");

    let byTopicRaw;
    try{
      byTopicRaw = await mapLimit(TOPICS, opts.concurrency, async (topic) => {
        try{
          const r = await fetchTopic(topic, opts);
          return { ...r, error: null };
        }catch(e){
          return { topicKey: topic.key, topicLabel: topic.label, query: "", url: "", articles: [], error: String(e.message || e) };
        }
      });
    }catch(e){
      setStatus(String(e.message || e), true);
      el.runBtn.disabled = false;
      return;
    }

    const keptAll = [];
    let countRaw = 0;

    const scoredByTopic = byTopicRaw.map(t => {
      const rawArticles = (t.articles || []);
      countRaw += rawArticles.length;

      const items = rawArticles.map(a => {
        const title = a.title || "(no title)";
        const url = a.url || a.url_mobile || "#";
        const domain = a.domain || "";
        const seenDate = parseGdeltSeenDate(a.seendate || a.seenDate || "");

        const effKey = effectiveTopicKey(t.topicKey, title);
        const r = headlineTradeability({ topicKey: effKey, title, seenDate }, nowUtc);
        if(r.filteredOut) return null;

        const h = {
          topicKey: effKey,
          topicLabel: t.topicLabel,
          title, url, domain,
          seenDate: seenDate ? seenDate.toISOString() : null,
          trade01: r.trade01,
          score10: r.score10,
          clarity: r.clarity,
          timing: r.timing,
          shock: r.shock,
          soft: r.soft
        };
        keptAll.push(h);
        return h;
      }).filter(Boolean);

      return {
        topicKey: t.topicKey,
        topicLabel: t.topicLabel,
        query: t.query,
        url: t.url,
        error: t.error,
        rawCount: rawArticles.length,
        items
      };
    });

    const tickerTable = aggregateTickerScores(keptAll);

    const strongCatalysts = keptAll.filter(h => h.score10 >= 7 && h.clarity >= 0.55 && !h.soft).length;
    const avgTrade01 = keptAll.length ? (keptAll.reduce((s,h)=>s + (h.trade01 || 0), 0) / keptAll.length) : 0;

    let noTrade = false;
    let topPicks = [];

    if(keptAll.length === 0){
      noTrade = true;
    } else if(strongCatalysts < RUNTIME.minCatalysts || avgTrade01 < RUNTIME.minAvgTrade01){
      noTrade = true;
    } else {
      topPicks = tickerTable.slice(0,3);
      if(topPicks.length && topPicks[0].score <= 0) noTrade = true;
      if(noTrade) topPicks = [];
    }

    const scan = {
      createdAt: nowUtc.toISOString(),
      opts,
      byTopic: scoredByTopic,
      countRaw,
      countKept: keptAll.length,
      strongCatalysts,
      avgTrade01,
      noTrade,
      tickerTable,
      topPicks,
      strictnessPct: Math.round(RUNTIME.strictness * 100)
    };

    lastScan = scan;

    if(countRaw === 0){
      setStatus("No headlines returned. Try a longer lookback or remove filters.", true);
    } else if(scan.noTrade){
      setStatus(`NO TRADE: gates not met (strong=${scan.strongCatalysts}, avg=${round2(scan.avgTrade01)}, kept=${scan.countKept}, strict=${scan.strictnessPct}%).`, true);
    } else {
      const errCount = scoredByTopic.filter(x=>x.error).length;
      setStatus(errCount ? `Completed with ${errCount} topic errors (see Headlines tab).` : "Completed.");
    }

    renderAll(scan);
    el.runBtn.disabled = false;
    el.saveBtn.disabled = false;
    el.exportBtn.disabled = false;
  }

  // ---------- Export / Save ----------
  function saveCurrent(){
    if(!lastScan) return;
    const arr = loadHistory();
    arr.unshift(lastScan);
    saveHistory(arr);
    refreshHistoryDropdown();
    setStatus("Saved to History.");
  }

  function exportJson(){
    if(!lastScan) return;
    const blob = new Blob([JSON.stringify(lastScan, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `scan_${new Date(lastScan.createdAt).toISOString().replaceAll(":","-")}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearHistory(){
    localStorage.removeItem(STORAGE_KEY);
    refreshHistoryDropdown();
    setStatus("History cleared.");
  }

  function loadFromHistoryIndex(idx){
    const arr = loadHistory();
    const scan = arr[idx];
    if(!scan) return;
    lastScan = scan;
    setStatus("Loaded saved scan (no re-fetch).");
    renderAll(scan);
    el.saveBtn.disabled = false;
    el.exportBtn.disabled = false;
  }

  // ---------- Events ----------
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", () => setActiveTab(t.dataset.tab));
  });

  el.runBtn.addEventListener("click", runScan);
  el.saveBtn.addEventListener("click", saveCurrent);
  el.exportBtn.addEventListener("click", exportJson);
  el.clearHistoryBtn.addEventListener("click", clearHistory);

  el.history.addEventListener("change", () => {
    const v = el.history.value;
    if(!v) return;
    loadFromHistoryIndex(Number(v));
  });

  el.strictness.addEventListener("input", applyStrictnessFromUI);
  el.strictnessNum.addEventListener("change", () => {
    el.strictness.value = el.strictnessNum.value;
    applyStrictnessFromUI();
  });

  // Init
  refreshHistoryDropdown();
  setActiveTab("picks");
  renderMethod();
  applyStrictnessFromUI();
})();
</script>
</body>
</html>
